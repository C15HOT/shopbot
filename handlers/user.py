from aiogram import Router, F
from aiogram.filters import CommandStart
from aiogram.types import Message, CallbackQuery
from aiogram.utils.markdown import hbold, hcode

from config import WELCOME_MESSAGE, ORDER_MESSAGE, SELLER_CONTACT
from keyboards.inline import get_categories_keyboard, get_products_keyboard, get_product_detail_keyboard
from utils.database import get_categories, get_products_by_category, get_product

router = Router()

@router.message(CommandStart())
async def start_command(message: Message):
    """Handle /start command"""
    categories_kb = await get_categories_keyboard()
    if categories_kb:
        await message.answer(WELCOME_MESSAGE, reply_markup=categories_kb)
    else:
        await message.answer("‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.")

@router.callback_query(F.data.startswith("category_"))
async def show_category_products(callback: CallbackQuery):
    """Show products in selected category"""
    category_id = int(callback.data.split("_")[1])
    
    products_kb = await get_products_keyboard(category_id)
    categories = await get_categories()
    category_name = next((cat["name"] for cat in categories if cat["id"] == category_id), "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è")
    
    if products_kb:
        await callback.message.edit_text(
            f"üõçÔ∏è –¢–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {hbold(category_name)}:\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:",
            reply_markup=products_kb
        )
    else:
        await callback.message.edit_text(
            f"‚ùå –í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {hbold(category_name)} –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.",
            reply_markup=await get_categories_keyboard()
        )
    
    await callback.answer()

@router.callback_query(F.data.startswith("product_"))
async def show_product_detail(callback: CallbackQuery):
    """Show product details"""
    product_id = int(callback.data.split("_")[1])
    product = await get_product(product_id)
    
    if not product:
        await callback.answer("‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
        return
    
    product_text = f"""
üõçÔ∏è {hbold(product['name'])}

üìù {product['description']}

üí∞ –¶–µ–Ω–∞: {hbold(str(product['price']) + ' —Ä—É–±.')}
"""
    
    keyboard = get_product_detail_keyboard(product_id, product['category_id'])
    await callback.message.edit_text(product_text, reply_markup=keyboard)
    await callback.answer()

@router.callback_query(F.data.startswith("order_"))
async def make_order(callback: CallbackQuery):
    """Show seller contact for ordering"""
    product_id = int(callback.data.split("_")[1])
    product = await get_product(product_id)
    
    if not product:
        await callback.answer("‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
        return
    
    order_text = ORDER_MESSAGE.format(contact=SELLER_CONTACT)
    order_text += f"\n\nüõçÔ∏è –¢–æ–≤–∞—Ä: {hbold(product['name'])}"
    
    await callback.message.answer(order_text)
    await callback.answer("‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!")

@router.callback_query(F.data == "back_to_categories")
async def back_to_categories(callback: CallbackQuery):
    """Return to categories menu"""
    categories_kb = await get_categories_keyboard()
    if categories_kb:
        await callback.message.edit_text(WELCOME_MESSAGE, reply_markup=categories_kb)
    else:
        await callback.message.edit_text("‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.")
    await callback.answer()

@router.callback_query(F.data.startswith("back_to_category_"))
async def back_to_category(callback: CallbackQuery):
    """Return to category products"""
    category_id = int(callback.data.split("_")[3])
    
    products_kb = await get_products_keyboard(category_id)
    categories = await get_categories()
    category_name = next((cat["name"] for cat in categories if cat["id"] == category_id), "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è")
    
    if products_kb:
        await callback.message.edit_text(
            f"üõçÔ∏è –¢–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {hbold(category_name)}:\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:",
            reply_markup=products_kb
        )
    else:
        await callback.message.edit_text(
            f"‚ùå –í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {hbold(category_name)} –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.",
            reply_markup=await get_categories_keyboard()
        )
    
    await callback.answer()
